# ===================================================================
# GITHUB ACTIONS WORKFLOW - SEMANA 4 BACKEND EVALUATION
# ===================================================================
# 
# Este archivo define un pipeline de CI/CD completo para evaluar
# el backend de la Semana 4, enfoc√°ndose en la integraci√≥n con LangSmith.
#
# ESTRUCTURA DEL WORKFLOW:
# 1. SETUP: Verificaci√≥n del entorno y dependencias
# 2. LANGSMITH API KEY: Verificaci√≥n de API key v√°lida
# 3. DATA LOADING: Carga de documentos para testing
# 4. QUERY EXECUTION: Ejecutar consultas para generar trazas
# 5. TRACE VERIFICATION: Verificar trazas en LangSmith
# 6. RESULTADO FINAL: Consolidaci√≥n de resultados
#
# CRITERIOS DE EVALUACI√ìN SEMANA 4:
# - API Key v√°lida de LangSmith
# - Proyecto configurado correctamente
# - Trazas se env√≠an a LangSmith
# - Dashboard accesible v√≠a API
# - Metadata correcta en las trazas
# ===================================================================

name: Semana 4 - LangSmith Integration Evaluation

# ==================== CONFIGURACI√ìN DE TRIGGERS ====================
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ==================== VARIABLES DE ENTORNO ====================
env:
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
  LANGCHAIN_TRACING_V2: "true"
  LANGCHAIN_ENDPOINT: "https://api.smith.langchain.com"
  LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
  TEST_QUESTION: "¬øQu√© informaci√≥n importante contienen estos documentos?"

jobs:
  # ================================================================
  # JOB 1: SETUP - Verificar que el entorno b√°sico funciona
  # ================================================================
  
  setup-verification:
    name: "Setup & Dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx langsmith
          printf "%s" '${{ secrets.DRIVEKEY }}' > apikey.json
          mkdir -p docs logs
      
      - name: Verify basic functionality
        run: |
          echo "‚úÖ Dependencies installed successfully"
          echo "‚úÖ API key configured"
          echo "‚úÖ Directories created"
          echo "üöÄ Ready for Semana 4 evaluation"

  # ================================================================
  # JOB 2: LANGSMITH API KEY - Verificar API key v√°lida
  # ================================================================

  verify-langsmith-api-key:
    name: "Verify LangSmith API Key"
    runs-on: ubuntu-latest
    needs: [setup-verification]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx langsmith
          printf "%s" '${{ secrets.DRIVEKEY }}' > apikey.json
          mkdir -p docs logs
      
      - name: Test LangSmith API Key
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          echo "üîë Testing LangSmith API Key..."
          
          # Run pytest to verify API key
          pytest tests/semana4/test_langsmith_connection.py::test_langsmith_api_key_valid -v --tb=short
          
          echo "‚úÖ LangSmith API Key is valid"
      
      - name: Verify LangSmith Project Access
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          echo "üìä Verifying LangSmith project access..."
          
          # Run pytest to verify project access
          pytest tests/semana4/test_langsmith_connection.py::test_langsmith_project_accessible -v --tb=short
          
          echo "‚úÖ LangSmith project is accessible"

  # ================================================================
  # JOB 3: DATA LOADING - Cargar documentos para testing
  # ================================================================

  data-loading:
    name: "Load Test Documents"
    runs-on: ubuntu-latest
    needs: [verify-langsmith-api-key]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - run: |
          pip install -r requirements.txt
          pip install langsmith
          printf "%s" '${{ secrets.DRIVEKEY }}' > apikey.json
          mkdir -p docs logs
      
      # Usar configuraci√≥n de chunking del estudiante (de semana 2)
      - name: Load student's chunking configuration
        run: |
          python3 ./tests/semana2/random_chunking_selector.py --semana 2
          echo "‚ÑπÔ∏è Usando config de chunking del estudiante para cargar documentos"
      
      - name: Start server and load documents
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_TRACING_V2: "true"
          LANGCHAIN_ENDPOINT: "https://api.smith.langchain.com"
          LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
        run: |
          chmod +x run_server.sh
          ./run_server.sh
          
          # Test health endpoint to confirm server is working
          HEALTH_RESPONSE=$(curl -s http://localhost:8000/api/v1/health)
          echo "Health check response: $HEALTH_RESPONSE"
          
          # Load test documents
          echo "Loading test documents..."
          LOAD_RESPONSE=$(jq -n \
            --arg url "${{ secrets.BASE_URL }}" \
            --arg collection "semana4_test_collection" \
            --argjson chunking "$(echo "$RAND_CHUNKING" | jq '.chunking_config')" \
            '{source_url: $url, collection_name: $collection, chunking_config: $chunking}' \
            | curl -s -X POST -H "Content-Type: application/json" \
              -d @- http://localhost:8000/api/v1/documents/load-from-url 2>&1)
          
          echo "Load response: '$LOAD_RESPONSE'"
          
          if [[ -z "$LOAD_RESPONSE" ]]; then
            echo "‚ùå Empty response from document load curl command"
            exit 1
          fi
          
          # Check if response is valid JSON
          echo "$LOAD_RESPONSE" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "‚ùå Load response is not valid JSON: '$LOAD_RESPONSE'"
            exit 1
          fi
          
          PROCESSING_ID=$(echo "$LOAD_RESPONSE" | jq -r '.processing_id')
          echo "Started document loading with ID: $PROCESSING_ID"
          
          if [[ "$PROCESSING_ID" == "null" || -z "$PROCESSING_ID" ]]; then
            echo "‚ùå Failed to get processing_id from load response"
            exit 1
          fi
          
          # Wait for documents to be processed
          echo "Waiting for document processing to complete..."
          for i in {1..60}; do
            sleep 5
            if [ -d "docs/semana4_test_collection" ] && [ "$(find docs/semana4_test_collection -type f | wc -l)" -gt 0 ]; then
              FILE_COUNT=$(find docs/semana4_test_collection -type f | wc -l)
              echo "‚úÖ Documents processed successfully: $FILE_COUNT files"
              break
            fi
            echo "Waiting for processing... attempt $i/60"
          done
          
          # Final verification
          FINAL_COUNT=$(find docs/semana4_test_collection -type f 2>/dev/null | wc -l)
          if [ "$FINAL_COUNT" -eq 0 ]; then
            echo "‚ùå No documents were processed"
            exit 1
          fi
          
          echo "‚úÖ Document loading completed with $FINAL_COUNT files"

  # ================================================================
  # JOB 4: QUERY EXECUTION - Ejecutar consultas para generar trazas
  # ================================================================

  execute-query-test:
    name: "Execute Query Test"
    runs-on: ubuntu-latest
    needs: [data-loading]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - run: |
          pip install -r requirements.txt
          pip install langsmith
          printf "%s" '${{ secrets.DRIVEKEY }}' > apikey.json
          mkdir -p docs logs
      
      - name: Load student's chunking configuration
        run: |
          python3 ./tests/semana2/random_chunking_selector.py --semana 2
      
      - name: Ensure test documents are available
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_TRACING_V2: "true"
          LANGCHAIN_ENDPOINT: "https://api.smith.langchain.com"
          LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
        run: |
          chmod +x run_server.sh
          ./run_server.sh
          
          # Test health endpoint to confirm server is working
          HEALTH_RESPONSE=$(curl -s http://localhost:8000/api/v1/health)
          echo "Health check response: $HEALTH_RESPONSE"
          
          # Quick document load if needed
          if [ ! -d "docs/semana4_test_collection" ] || [ "$(find docs/semana4_test_collection -type f | wc -l)" -eq 0 ]; then
            echo "Reloading test documents..."
            
            LOAD_RESPONSE=$(jq -n \
              --arg url "${{ secrets.BASE_URL }}" \
              --arg collection "semana4_test_collection" \
              --argjson chunking "$(echo "$RAND_CHUNKING" | jq '.chunking_config')" \
              '{source_url: $url, collection_name: $collection, chunking_config: $chunking}' \
              | curl -s -X POST -H "Content-Type: application/json" \
                -d @- http://localhost:8000/api/v1/documents/load-from-url 2>&1)
            
            sleep 30
          fi
      
      - name: Execute Test Query
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_TRACING_V2: "true"
          LANGCHAIN_ENDPOINT: "https://api.smith.langchain.com"
          LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
        run: |
          echo "‚ùì Executing test query to generate LangSmith trace..."
          
          # Execute query
          QUERY_RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"question\": \"$TEST_QUESTION\", \"top_k\": 5, \"collection\": \"semana4_test_collection\"}" \
            http://localhost:8000/api/v1/ask 2>&1)
          
          echo "Query response: '$QUERY_RESPONSE'"
          
          if [[ -z "$QUERY_RESPONSE" ]]; then
            echo "‚ùå Empty response from query"
            exit 1
          fi
          
          # Check if response is valid JSON
          echo "$QUERY_RESPONSE" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "‚ùå Query response is not valid JSON: '$QUERY_RESPONSE'"
            exit 1
          fi
          
          # Verify response has expected structure
          ANSWER=$(echo "$QUERY_RESPONSE" | jq -r '.answer')
          if [[ "$ANSWER" == "null" || -z "$ANSWER" ]]; then
            echo "‚ùå Response missing answer field"
            exit 1
          fi
          
          echo "‚úÖ Query executed successfully"
          echo "Answer preview: ${ANSWER:0:100}..."
          
          # Execute additional queries to generate more traces
          echo "Executing additional queries for trace generation..."
          
          curl -s -X POST -H "Content-Type: application/json" \
            -d '{"question": "¬øCu√°les son los contratos principales?", "top_k": 3, "collection": "semana4_test_collection"}' \
            http://localhost:8000/api/v1/ask > /dev/null 2>&1
          
          curl -s -X POST -H "Content-Type: application/json" \
            -d '{"question": "¬øQu√© valores monetarios se mencionan?", "top_k": 3, "collection": "semana4_test_collection"}' \
            http://localhost:8000/api/v1/ask > /dev/null 2>&1
          
          echo "‚úÖ Multiple queries executed to generate traces"

  # ================================================================
  # JOB 5: TRACE VERIFICATION - Verificar trazas en LangSmith
  # ================================================================

  verify-langsmith-traces:
    name: "Verify Traces in LangSmith"
    runs-on: ubuntu-latest
    needs: [execute-query-test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx langsmith
          printf "%s" '${{ secrets.DRIVEKEY }}' > apikey.json
          mkdir -p docs logs
      
      - name: Wait for LangSmith to process traces
        run: |
          echo "‚è≥ Waiting 60 seconds for LangSmith to process traces..."
          sleep 60
          echo "‚úÖ Wait complete"
      
      - name: Verify Recent Traces Exist
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
        run: |
          echo "üîç Verifying traces in LangSmith..."
          
          # Run pytest to verify traces
          pytest tests/semana4/test_langsmith_traces.py::test_recent_traces_exist -v --tb=short
          
          echo "‚úÖ Recent traces found in LangSmith"
      
      - name: Verify Trace Metadata
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
        run: |
          echo "üìã Verifying trace metadata..."
          
          # Run pytest to verify trace metadata
          pytest tests/semana4/test_langsmith_traces.py::test_trace_has_correct_metadata -v --tb=short
          
          echo "‚úÖ Trace metadata is correct"
      
      - name: Verify Trace Content
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_PROJECT: "misw4411-backend-proyecto"
        run: |
          echo "üìù Verifying trace content..."
          
          # Run pytest to verify trace content
          pytest tests/semana4/test_langsmith_traces.py::test_trace_contains_rag_information -v --tb=short
          
          echo "‚úÖ Trace content is valid"

  # ================================================================
  # JOB 6: RESULTADO FINAL - Consolidaci√≥n de resultados
  # ================================================================

  final-status:
    name: "Final Status"
    runs-on: ubuntu-latest
    needs: [
      setup-verification,
      verify-langsmith-api-key,
      data-loading,
      execute-query-test,
      verify-langsmith-traces
    ]
    if: always()
    steps:
      - name: Check results
        run: |
          FAILURES=0
          
          # Check each job result
          if [[ "${{ needs.setup-verification.result }}" != "success" ]]; then 
            echo "‚ùå Setup verification failed"
            ((FAILURES++))
          fi
          
          if [[ "${{ needs.verify-langsmith-api-key.result }}" != "success" ]]; then 
            echo "‚ùå LangSmith API key verification failed"
            ((FAILURES++))
          fi
          
          if [[ "${{ needs.data-loading.result }}" != "success" ]]; then 
            echo "‚ùå Data loading failed"
            ((FAILURES++))
          fi
          
          if [[ "${{ needs.execute-query-test.result }}" != "success" ]]; then 
            echo "‚ùå Query execution failed"
            ((FAILURES++))
          fi
          
          if [[ "${{ needs.verify-langsmith-traces.result }}" != "success" ]]; then 
            echo "‚ùå Trace verification failed"
            ((FAILURES++))
          fi
          
          echo "Critical failures: $FAILURES"
          
          if [ $FAILURES -eq 0 ]; then
            echo "‚úÖ All Semana 4 tests passed!"
            echo "üéâ LangSmith integration verified successfully"
            echo ""
            echo "üìä SEMANA 4 EVALUATION COMPLETE:"
            echo "   ‚úÖ API Key: Valid and working"
            echo "   ‚úÖ Project: Configured correctly"
            echo "   ‚úÖ Traces: Being sent to LangSmith"
            echo "   ‚úÖ Dashboard: Accessible via API"
            echo "   ‚úÖ Metadata: Correct in traces"
            echo "   ‚úÖ Integration: Complete and functional"
            exit 0
          else
            echo "‚ùå $FAILURES critical tests failed"
            echo ""
            echo "üìã SEMANA 4 EVALUATION FAILED:"
            echo "   Please check the individual job logs for details"
            echo "   Focus on: LangSmith API key, configuration, and trace generation"
            exit 1
          fi

# ===================================================================
# NOTAS IMPORTANTES PARA SEMANA 4:
# ===================================================================
#
# 1. API KEY:
# - Los estudiantes deben agregar su LANGSMITH_API_KEY a GitHub Secrets
# - La key debe ser v√°lida y tener permisos de lectura/escritura
#
# 2. CONFIGURACI√ìN:
# - LANGCHAIN_TRACING_V2 debe estar en "true"
# - LANGCHAIN_PROJECT debe tener un nombre v√°lido
# - El servidor debe tener las variables de entorno configuradas
#
# 3. TRAZAS:
# - Las trazas tardan ~60 segundos en procesarse
# - Debe haber al menos 1 traza generada durante los tests
# - Las trazas deben contener informaci√≥n de RAG (contexto, respuesta)
#
# 4. INDEPENDENCIA DE JOBS:
# - Cada Job se ejecuta en una m√°quina virtual nueva
# - Por eso cada Job reinstala dependencias y recrea el entorno
# - Los Jobs no comparten estado entre s√≠
#
# ===================================================================
